name: Code Signing Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build Executables
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install PyInstaller
        run: pip install pyinstaller
      
      - name: Build executables
        run: |
          python build_scripts/build.py
      
      - name: Upload unsigned artifacts
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-executables
          path: artifacts/unsigned/*.exe
          retention-days: 30

  sign:
    name: Sign Executables
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y softhsm2 osslsigncode openssl
      
      - name: Download unsigned artifacts
        uses: actions/download-artifact@v4
        with:
          name: unsigned-executables
          path: artifacts/unsigned/
      
      - name: Generate demo certificates
        run: |
          bash certs/generate_certs.sh
      
      - name: Initialize SoftHSM
        run: |
          bash hsm/init_hsm.sh
        env:
          SOFTHSM2_CONF: ${{ github.workspace }}/hsm/softhsm.conf
      
      - name: Import key to HSM
        run: |
          bash hsm/import_to_hsm.sh
        env:
          SOFTHSM2_CONF: ${{ github.workspace }}/hsm/softhsm.conf
      
      - name: Sign executables
        run: |
          python build_scripts/sign.py
        env:
          SOFTHSM2_CONF: ${{ github.workspace }}/hsm/softhsm.conf
      
      - name: Upload signed artifacts
        uses: actions/upload-artifact@v4
        with:
          name: signed-executables
          path: artifacts/signed/*.exe
          retention-days: 30

  verify:
    name: Verify Signatures
    runs-on: ubuntu-latest
    needs: sign
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y osslsigncode
      
      - name: Download signed artifacts
        uses: actions/download-artifact@v4
        with:
          name: signed-executables
          path: artifacts/signed/
      
      - name: Download certificates
        uses: actions/download-artifact@v4
        with:
          name: certificates
          path: certs/
          if-no-files-found: ignore
      
      - name: Generate demo certificates (if needed)
        run: |
          if [ ! -f certs/ca.cert.pem ]; then
            bash certs/generate_certs.sh
          fi
        continue-on-error: true
      
      - name: Verify signatures
        run: |
          python build_scripts/verify.py
      
      - name: Upload verification results
        uses: actions/upload-artifact@v4
        with:
          name: verification-results
          path: artifacts/signed/*.verify.json
          retention-days: 30

  deploy:
    name: Deploy to Demo Server
    runs-on: ubuntu-latest
    needs: [build, sign, verify]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download signed artifacts
        uses: actions/download-artifact@v4
        with:
          name: signed-executables
          path: artifacts/signed/
      
      - name: Deploy to server
        run: |
          echo "Deploy signed artifacts to demo server"
          # Add your deployment logic here
          # Example: scp, rsync, or upload to cloud storage
        env:
          # Add deployment credentials as secrets
          # SERVER_HOST: ${{ secrets.SERVER_HOST }}
          # SERVER_USER: ${{ secrets.SERVER_USER }}
          # DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}

